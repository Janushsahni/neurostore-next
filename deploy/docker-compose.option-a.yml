name: neurostore-option-a

services:
  control-plane:
    build:
      context: ..
      dockerfile: services/control-plane/Dockerfile
    environment:
      PORT: "8080"
      MACAROON_SECRET: "${MACAROON_SECRET:-change-me-before-prod}"
      INTERNAL_API_TOKEN: "${INTERNAL_API_TOKEN:-change-me-internal-token}"
      STATE_BACKEND: "${STATE_BACKEND:-postgres}"
      STATE_REDIS_KEY: "${STATE_REDIS_KEY:-neurostore:control-plane:state}"
      STATE_PG_TABLE: "${STATE_PG_TABLE:-control_plane_state}"
      STATE_MIRROR_FILE: "${STATE_MIRROR_FILE:-true}"
      STATE_BACKEND_FALLBACK_TO_FILE: "${STATE_BACKEND_FALLBACK_TO_FILE:-true}"
      CONTROL_PLANE_DATA_DIR: "/var/lib/neurostore/control-plane"
      DATABASE_URL: "${DATABASE_URL:-postgres://neurostore:neurostore@postgres:5432/neurostore}"
      REDIS_URL: "${REDIS_URL:-redis://redis:6379}"
      NATS_URL: "${NATS_URL:-nats://nats:4222}"
      KAFKA_BROKERS: "${KAFKA_BROKERS:-redpanda:9092}"
    depends_on:
      - postgres
      - redis
      - nats
      - redpanda
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:8080/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 5
    volumes:
      - control-plane-data:/var/lib/neurostore/control-plane
    ports:
      - "8080:8080"

  s3-gateway:
    build:
      context: ..
      dockerfile: services/s3-gateway/Dockerfile
    environment:
      PORT: "9009"
      CONTROL_PLANE_URL: "http://control-plane:8080"
      REQUIRE_AUTH: "true"
      PRESIGN_SECRET: "${PRESIGN_SECRET:-change-me-presign-secret}"
      INTERNAL_API_TOKEN: "${INTERNAL_API_TOKEN:-change-me-internal-token}"
      SIGV4_MAX_SKEW_SECONDS: "${SIGV4_MAX_SKEW_SECONDS:-900}"
      SIGV4_PROVIDER: "${SIGV4_PROVIDER:-hybrid}"
      SIGV4_CACHE_TTL_MS: "${SIGV4_CACHE_TTL_MS:-60000}"
      SIGV4_CREDENTIALS_JSON: '${SIGV4_CREDENTIALS_JSON:-[{"access_key":"demo-access-key","secret_key":"demo-secret-key","bucket":"*","prefix":"*","ops":["put","get","head","list","delete"],"region":"us-east-1","service":"s3"}]}'
      S3_DATA_DIR: "/var/lib/neurostore/s3-gateway/data"
      S3_META_FILE: "/var/lib/neurostore/s3-gateway/metadata.json"
      S3_MULTIPART_DIR: "/var/lib/neurostore/s3-gateway/multipart"
    depends_on:
      - control-plane
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:9009/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 5
    volumes:
      - s3-gateway-data:/var/lib/neurostore/s3-gateway
    ports:
      - "9009:9009"

  node-1:
    build:
      context: ..
      dockerfile: deploy/docker/node.Dockerfile
    command:
      - --storage-path
      - /var/lib/neuro-node
      - --max-gb
      - "100"
      - --listen
      - /ip4/0.0.0.0/tcp/9000
    ports:
      - "9000:9000"
    restart: unless-stopped
    volumes:
      - node-1-data:/var/lib/neuro-node

  node-2:
    build:
      context: ..
      dockerfile: deploy/docker/node.Dockerfile
    command:
      - --storage-path
      - /var/lib/neuro-node
      - --max-gb
      - "100"
      - --listen
      - /ip4/0.0.0.0/tcp/9001
    ports:
      - "9001:9001"
    restart: unless-stopped
    volumes:
      - node-2-data:/var/lib/neuro-node

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: neurostore
      POSTGRES_PASSWORD: neurostore
      POSTGRES_DB: neurostore
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neurostore -d neurostore"]
      interval: 15s
      timeout: 5s
      retries: 5
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7
    restart: unless-stopped
    ports:
      - "6379:6379"

  nats:
    image: nats:2.10
    command:
      - --jetstream
      - --store_dir
      - /data
    ports:
      - "4222:4222"
      - "8222:8222"
    restart: unless-stopped
    volumes:
      - nats-data:/data

  redpanda:
    image: redpandadata/redpanda:v24.1.15
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
      - --pandaproxy-addr
      - 0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - redpanda:8082
    ports:
      - "9092:9092"
      - "8082:8082"
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector:0.95.0
    command:
      - --config=/etc/otelcol/config.yaml
    restart: unless-stopped
    volumes:
      - ./observability/otel-collector.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"

  prometheus:
    image: prom/prometheus:v2.51.2
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    restart: unless-stopped
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:10.4.2
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

volumes:
  control-plane-data:
  s3-gateway-data:
  node-1-data:
  node-2-data:
  postgres-data:
  nats-data:
