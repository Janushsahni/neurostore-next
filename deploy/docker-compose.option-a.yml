x-common: &common
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

services:
  postgres:
    <<: *common
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-neuro_admin}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-neuro_dev_password_2026}"
      POSTGRES_DB: "${POSTGRES_DB:-neurostore_production}"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    <<: *common
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  control-plane:
    <<: *common
    build:
      context: ../services/control-plane
      dockerfile: ../../deploy/Dockerfile.services
    ports:
      - "${CP_PORT:-8080}:8080"
    environment:
      PORT: 8080
      MACAROON_SECRET: "${MACAROON_SECRET:-dev-secret-change-in-production}"
      NODE_SHARED_SECRET: "${NODE_SHARED_SECRET:-dev-node-secret-change-in-production}"
      SESSION_TTL_SECS: "${SESSION_TTL_SECS:-86400}"
      COOKIE_SECURE: "${COOKIE_SECURE:-false}"
      CP_RATE_LIMIT_RPS: "${CP_RATE_LIMIT_RPS:-120}"
      CP_AUTH_LOCK_THRESHOLD: "${CP_AUTH_LOCK_THRESHOLD:-8}"
      CP_AUTH_LOCK_SECS: "${CP_AUTH_LOCK_SECS:-300}"
      DATABASE_URL: "${DATABASE_URL:-postgres://neuro_admin:neuro_dev_password_2026@postgres:5432/neurostore_production}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:8080/readyz').then(r=>process.exit(r.ok?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  s3-gateway:
    <<: *common
    build:
      context: ..
      dockerfile: deploy/Dockerfile.gateway
    ports:
      - "${S3_PORT:-9009}:9009"
      - "${GATEWAY_P2P_PORT:-9010}:9010"
    environment:
      PORT: 9009
      DATABASE_URL: "${DATABASE_URL:-postgres://neuro_admin:neuro_dev_password_2026@postgres:5432/neurostore_production}"
      REDIS_URL: "${REDIS_URL:-redis://redis:6379}"
      METADATA_SECRET: "${METADATA_SECRET:-dev-metadata-secret-change-in-production}"
      JWT_SECRET: "${JWT_SECRET:-dev-jwt-secret-change-in-production}"
      PROOF_SUBMIT_TOKEN: "${PROOF_SUBMIT_TOKEN:-dev-proof-submit-token-change-in-production}"
      COMPLIANCE_SIGNING_KEY: "${COMPLIANCE_SIGNING_KEY:-dev-compliance-signing-key-change-in-production}"
      COOKIE_SECURE: "${COOKIE_SECURE:-false}"
      GATEWAY_RATE_LIMIT_RPS: "${GATEWAY_RATE_LIMIT_RPS:-200}"
      RUST_LOG: "${RUST_LOG:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      control-plane:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:9009/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  neuro-node:
    <<: *common
    build:
      context: ..
      dockerfile: deploy/Dockerfile.node
    ports:
      - "${NODE_P2P_PORT:-9000}:9000"
    environment:
      RUST_LOG: "${RUST_LOG:-info}"
    volumes:
      - node-data:/data
    command: >
      /usr/local/bin/neuro-node
        --storage-path /data
        --max-gb ${NODE_MAX_GB:-50}
        --listen /ip4/0.0.0.0/tcp/9000

volumes:
  postgres-data:
  redis-data:
  node-data:
