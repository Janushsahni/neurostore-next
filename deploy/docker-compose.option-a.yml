# ═══════════════════════════════════════════════════════════════
# NeuroStore Option-A Production Stack
# Control Plane · S3 Gateway · Storage Node
# ═══════════════════════════════════════════════════════════════

version: "3.9"

x-common: &common
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

services:
  # ── Control Plane ────────────────────────────────────────────
  control-plane:
    <<: *common
    build:
      context: ../services/control-plane
      dockerfile: ../../deploy/Dockerfile.services
    ports:
      - "${CP_PORT:-8080}:8080"
    environment:
      PORT: 8080
      MACAROON_SECRET: "${MACAROON_SECRET:-dev-secret-change-in-production}"
      STATE_BACKEND: "${STATE_BACKEND:-memory}"
      DATABASE_URL: "${DATABASE_URL:-}"
      REDIS_URL: "${REDIS_URL:-}"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:8080/readyz').then(r=>process.exit(r.ok?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ── S3 Gateway ───────────────────────────────────────────────
  s3-gateway:
    <<: *common
    build:
      context: ../services/s3-gateway
      dockerfile: ../../deploy/Dockerfile.services
    ports:
      - "${S3_PORT:-9009}:9009"
    environment:
      PORT: 9009
      CONTROL_PLANE_URL: "http://control-plane:8080"
    depends_on:
      control-plane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:9009/readyz').then(r=>process.exit(r.ok?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ── Storage Node ─────────────────────────────────────────────
  neuro-node:
    <<: *common
    build:
      context: ..
      dockerfile: deploy/Dockerfile.node
    ports:
      - "${NODE_P2P_PORT:-9000}:9000"
    environment:
      RUST_LOG: info
    volumes:
      - node-data:/data
    command: >
      /usr/local/bin/neuro-node
        --storage-path /data
        --max-gb ${NODE_MAX_GB:-50}
        --listen /ip4/0.0.0.0/tcp/9000

volumes:
  node-data:
    driver: local
